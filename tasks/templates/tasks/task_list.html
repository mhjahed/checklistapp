{% extends 'tasks/base.html' %}

{% block content %}
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
        <!-- Left Column: Task Form -->
        <div class="lg:col-span-5 bg-white dark:bg-dark-card rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold mb-4 text-gray-700 dark:text-white">Add New Task</h2>
            <form id="task-form" method="post" action="{% url 'task_create' %}" class="space-y-4">
                {% csrf_token %}
                <div>
                    <label for="{{ form.title.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Task Title</label>
                    {{ form.title }}
                </div>
                <div>
                    <label for="{{ form.description.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Description</label>
                    {{ form.description }}
                </div>
                <div>
                    <label for="{{ form.due_date.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Due Date & Time</label>
                    {{ form.due_date }}
                </div>
                <div>
                    <label for="{{ form.notify_before.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Notify Before</label>
                    {{ form.notify_before }}
                </div>
                <div class="pt-2">
                    <button type="submit" 
                        class="w-full py-2 px-4 bg-primary hover:bg-primary-dark text-white rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition-colors">
                        <i class="fas fa-plus mr-2"></i>Add Task
                    </button>
                </div>
            </form>
            <div id="notification-permission" class="hidden mt-4 p-4 bg-yellow-100 dark:bg-yellow-800 rounded-md">
                <p class="text-yellow-800 dark:text-yellow-200 text-sm">
                    <i class="fas fa-bell mr-2"></i> 
                    Please enable notifications to receive task reminders.
                    <button id="enable-notifications" class="ml-2 underline">Enable</button>
                </p>
            </div>
        </div>

        <!-- Right Column: Task List -->
        <div class="lg:col-span-7">
            <div class="bg-white dark:bg-dark-card rounded-lg shadow-md p-6 mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-gray-700 dark:text-white">Upcoming Tasks</h2>
                    <div class="flex space-x-2">
                        <select id="task-filter" class="text-sm border border-gray-300 rounded-md py-1 px-2 focus:outline-none focus:ring-primary focus:border-primary dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                            <option value="all">All Tasks</option>
                            <option value="pending">Pending</option>
                            <option value="completed">Completed</option>
                        </select>
                        <button id="sort-by-date" class="text-sm border border-gray-300 rounded-md py-1 px-2 hover:bg-gray-100 dark:border-gray-600 dark:hover:bg-gray-700 dark:text-white">
                            <i class="fas fa-sort"></i> Date
                        </button>
                    </div>
                </div>
                <div id="task-list" class="space-y-3 max-h-[calc(100vh-300px)] overflow-y-auto pr-1">
                    <!-- Tasks will be inserted here by JS -->
                    <div id="empty-task-message" class="text-center py-8 text-gray-500 dark:text-gray-400 {% if tasks %}hidden{% endif %}">
                        <i class="fas fa-clipboard-list text-3xl mb-2"></i>
                        <p>No tasks yet. Add a task to get started!</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white dark:bg-dark-card rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold mb-4 text-gray-700 dark:text-white">Task Statistics</h2>
                <div class="grid grid-cols-2 gap-4 text-center">
                    <div class="p-4 bg-blue-50 dark:bg-blue-900/30 rounded-lg">
                        <p class="text-sm text-blue-700 dark:text-blue-300">Pending Tasks</p>
                        <p id="pending-count" class="text-2xl font-bold text-blue-700 dark:text-blue-300">{{ pending_count }}</p>
                    </div>
                    <div class="p-4 bg-green-50 dark:bg-green-900/30 rounded-lg">
                        <p class="text-sm text-green-700 dark:text-green-300">Completed Tasks</p>
                        <p id="completed-count" class="text-2xl font-bold text-green-700 dark:text-green-300">{{ completed_count }}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Task Edit Modal -->
    <div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-dark-card rounded-lg shadow-xl p-6 w-full max-w-md mx-4">
            <h2 class="text-xl font-semibold mb-4 text-gray-700 dark:text-white">Edit Task</h2>
            <form id="edit-form" method="post" class="space-y-4">
                {% csrf_token %}
                <div>
                    <label for="edit-task-title" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Task Title</label>
                    <input type="text" id="edit-task-title" name="title" required
                        class="mt-1 block w-full px-3 py-2 text-base border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                </div>
                <div>
                    <label for="edit-task-description" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Description</label>
                    <textarea id="edit-task-description" name="description" rows="3"
                        class="mt-1 block w-full px-3 py-2 text-base border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary dark:bg-gray-700 dark:border-gray-600 dark:text-white"></textarea>
                </div>
                <div>
                    <label for="edit-task-date" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Due Date & Time</label>
                    <input type="datetime-local" id="edit-task-date" name="due_date" required
                        class="mt-1 block w-full px-3 py-2 text-base border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                </div>
                <div>
                    <label for="edit-notification-time" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Notify Before</label>
                    <select id="edit-notification-time" name="notify_before"
                        class="mt-1 block w-full px-3 py-2 text-base border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        <option value="0">At time of task</option>
                        <option value="5">5 minutes before</option>
                        <option value="15">15 minutes before</option>
                        <option value="30">30 minutes before</option>
                        <option value="60">1 hour before</option>
                        <option value="1440">1 day before</option>
                    </select>
                </div>
                <div class="flex justify-end space-x-3 pt-2">
                    <button type="button" id="close-modal" 
                        class="py-2 px-4 bg-gray-200 hover:bg-gray-300 text-gray-800 rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 dark:bg-gray-700 dark:text-white dark:hover:bg-gray-600 transition-colors">
                        Cancel
                    </button>
                    <button type="submit" 
                        class="py-2 px-4 bg-primary hover:bg-primary-dark text-white rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition-colors">
                        Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const taskForm = document.getElementById('task-form');
        const taskList = document.getElementById('task-list');
        const emptyTaskMessage = document.getElementById('empty-task-message');
        const taskFilter = document.getElementById('task-filter');
        const sortByDateBtn = document.getElementById('sort-by-date');
        const pendingCountEl = document.getElementById('pending-count');
        const completedCountEl = document.getElementById('completed-count');
        const notificationPermission = document.getElementById('notification-permission');
        const enableNotifications = document.getElementById('enable-notifications');
        const editModal = document.getElementById('edit-modal');
        const editForm = document.getElementById('edit-form');
        const closeModal = document.getElementById('close-modal');
        
        // Make form inputs look like Tailwind inputs
        const applyTailwindClasses = () => {
            document.querySelectorAll('input, textarea, select').forEach(el => {
                if (!el.classList.contains('task-checkbox') && !el.type === 'hidden') {
                    el.classList.add('mt-1', 'block', 'w-full', 'px-3', 'py-2', 'text-base', 'border', 'border-gray-300', 'rounded-md', 'shadow-sm', 'focus:outline-none', 'focus:ring-primary', 'focus:border-primary', 'dark:bg-gray-700', 'dark:border-gray-600', 'dark:text-white');
                }
            });
        };
        
        applyTailwindClasses();
        
        // Notification permission check
        function checkNotificationPermission() {
            if (!("Notification" in window)) {
                notificationPermission.classList.remove('hidden');
                notificationPermission.querySelector('p').textContent = "This browser does not support desktop notifications.";
                return;
            }

            if (Notification.permission === "default") {
                notificationPermission.classList.remove('hidden');
            }
        }

        enableNotifications.addEventListener('click', function() {
            Notification.requestPermission().then(function(permission) {
                if (permission === "granted") {
                    notificationPermission.classList.add('hidden');
                }
            });
        });
        
        // Load tasks via AJAX
        function loadTasks() {
            const filter = taskFilter.value;
            fetch(/tasks/api/tasks/?filter=${filter})
                .then(response => response.json())
                .then(data => {
                    renderTasks(data.tasks);
                    updateCounts();
                });
        }
        
        // Update task counts
        function updateCounts() {
            fetch('/tasks/api/counts/')
                .then(response => response.json())
                .then(data => {
                    pendingCountEl.textContent = data.pending_count;
                    completedCountEl.textContent = data.completed_count;
                });
        }
        
        // Render tasks in the UI
        function renderTasks(tasks) {
            // Clear task list except for empty message
            const children = Array.from(taskList.children);
            children.forEach(child => {
                if (child !== emptyTaskMessage) {
                    child.remove();
                }
            });

            // Show/hide empty message
            if (tasks.length === 0) {
                emptyTaskMessage.classList.remove('hidden');
                const filter = taskFilter.value;
                if (filter !== 'all') {
                    emptyTaskMessage.querySelector('p').textContent = No ${filter} tasks found.;
                } else {
                    emptyTaskMessage.querySelector('p').textContent = 'No tasks yet. Add a task to get started!';
                }
            } else {
                emptyTaskMessage.classList.add('hidden');
            }

            // Add tasks to list
            tasks.forEach(task => {
                const taskEl = document.createElement('div');
                taskEl.className = p-4 border ${task.completed ? 'bg-gray-50 dark:bg-gray-800/50 border-gray-200' : 'bg-white dark:bg-dark-card border-gray-200'} rounded-lg shadow-sm transition-all hover:shadow-md;
                
                const isPastDue = !task.completed && task.is_past_due;

                taskEl.innerHTML = `
                    <div class="flex items-start justify-between">
                        <div class="flex items-start space-x-3 flex-1">
                            <div class="pt-1">
                                <input type="checkbox" ${task.completed ? 'checked' : ''} class="task-checkbox w-5 h-5 rounded text-primary focus:ring-primary dark:bg-gray-700" data-id="${task.id}">
                            </div>
                            <div class="flex-1 min-w-0">
                                <h3 class="text-lg font-medium ${task.completed ? 'line-through text-gray-500 dark:text-gray-400' : 'text-gray-800 dark:text-white'} truncate">
                                    ${task.title}
                                </h3>
                                <p class="mt-1 text-sm text-gray-600 dark:text-gray-300 ${task.completed ? 'line-through text-gray-400 dark:text-gray-500' : ''}">
                                    ${task.description || 'No description'}
                                </p>
                                <div class="mt-2 flex items-center space-x-2">
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${isPastDue ? 'bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300' : 'bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300'}">
                                        <i class="fas fa-clock mr-1"></i>
                                        ${task.due_date_formatted.date} at ${task.due_date_formatted.time}
                                    </span>
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-300">
                                        <i class="fas fa-bell mr-1"></i>
                                        ${task.notify_before > 0 ? formatMinutes(task.notify_before) + ' before' : 'At time of task'}
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="flex space-x-2 ml-2">
                            <button class="task-edit p-1 text-gray-500 hover:text-primary dark:text-gray-400 dark:hover:text-primary transition-colors" data-id="${task.id}">
                                <i class="fas fa-pencil-alt"></i>
                            </button>
                            <button class="task-delete p-1 text-gray-500 hover:text-red-500 dark:text-gray-400 dark:hover:text-red-400 transition-colors" data-id="${task.id}">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    </div>
                `;

                taskList.appendChild(taskEl);
            });

            // Add event listeners to new elements
            document.querySelectorAll('.task-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    toggleTaskCompletion(this.dataset.id, this.checked);
                });
            });

            document.querySelectorAll('.task-delete').forEach(button => {
                button.addEventListener('click', function() {
                    if (confirm('Are you sure you want to delete this task?')) {
                        deleteTask(this.dataset.id);
                    }
                });
            });

            document.querySelectorAll('.task-edit').forEach(button => {
                button.addEventListener('click', function() {
                    openEditModal(this.dataset.id);
                });
            });
        }
        
        // Format minutes for notification message
        function formatMinutes(minutes) {
            if (minutes == 1440) return "1 day";
            if (minutes == 60) return "1 hour";
            if (minutes < 60) return ${minutes} minutes;
            return ${minutes / 60} hours;
        }
        
        // Toggle task completion via AJAX
        function toggleTaskCompletion(id, completed) {
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            
            fetch(/tasks/${id}/toggle/, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ completed: completed })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    loadTasks();
                }
            });
        }
        
        // Delete task via AJAX
        function deleteTask(id) {
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            
            fetch(/tasks/${id}/delete/, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': csrfToken
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    loadTasks();
                }
            });
        }
        
        // Open edit modal with task data
        function openEditModal(id) {
            fetch(/tasks/api/tasks/?filter=all)
                .then(response => response.json())
                .then(data => {
                    const task = data.tasks.find(t => t.id == id);
                    if (task) {
                        editForm.action = /tasks/${id}/update/;
                        document.getElementById('edit-task-title').value = task.title;
                        document.getElementById('edit-task-description').value = task.description || '';
                        document.getElementById('edit-task-date').value = task.due_date;
                        document.getElementById('edit-notification-time').value = task.notify_before;
                        
                        editModal.classList.remove('hidden');
                    }
                });
        }
        
        // Close edit modal
        function closeEditModal() {
            editModal.classList.add('hidden');
            editForm.reset();
        }
        
        // Submit task form via AJAX
        taskForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            
            fetch(this.action, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': csrfToken
                },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    loadTasks();
                    taskForm.reset();
                    
                    // Set default date to tomorrow
                    const tomorrow = new Date();
                    tomorrow.setDate(tomorrow.getDate() + 1);
                    tomorrow.setHours(9, 0, 0, 0);
                    document.getElementById('id_due_date').value = tomorrow.toISOString().slice(0, 16);
                }
            });
        });
        
        // Submit edit form via AJAX
        editForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            
            fetch(this.action, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': csrfToken
                },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    loadTasks();
                    closeEditModal();
                }
            });
        });
        
        // Event listeners
        taskFilter.addEventListener('change', loadTasks);
        sortByDateBtn.addEventListener('click', loadTasks);
        closeModal.addEventListener('click', closeEditModal);
        
        // Initialize the task list
        loadTasks();
        checkNotificationPermission();
        
        // Set up notification checker (check every minute)
        function setupNotificationChecker() {
            checkDueNotifications();
            setInterval(checkDueNotifications, 60000);
        }
        
        // Check for tasks with notifications due
        function checkDueNotifications() {
            fetch('/tasks/api/tasks/?filter=pending')
                .then(response => response.json())
                .then(data => {
                    const tasks = data.tasks;
                    const now = new Date();
                    
                    tasks.forEach(task => {
                        const dueDate = new Date(task.due_date);
                        const notifyTime = new Date(dueDate.getTime() - (task.notify_before * 60000));
                        
                        // Check if notification time is between now and one minute ago
                        if (notifyTime <= now && notifyTime > new Date(now.getTime() - 60000)) {
                            sendNotification(task);
                        }
                    });
                });
        }
        
        // Send browser notification
        function sendNotification(task) {
            if (Notification.permission === "granted") {
                const dueDate = new Date(task.due_date);
                const timeStr = dueDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const title = task.title;
                const options = {
                    body: task.notify_before === 0 ? 
                        Task is due now (${timeStr}) : 
                        Task is due in ${formatMinutes(task.notify_before)} (${timeStr}),
                    icon: 'https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/svgs/solid/bell.svg'
                };
                new Notification(title, options);
            }
        }
        
        // Start notification checker
        if (Notification.permission === "granted") {
            setupNotificationChecker();
        }
    });
</script>
{% endblock %}